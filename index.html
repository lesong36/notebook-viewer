<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook æŸ¥çœ‹å™¨</title>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <!-- Mermaid.js for Diagram rendering -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });
        window.mermaid = mermaid;
    </script>

    <!-- KaTeX for Math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            overflow: hidden;
        }

        /* å·¥å…·æ  */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            z-index: 1000;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-divider {
            width: 1px;
            height: 28px;
            background: #e2e8f0;
            margin: 0 8px;
        }

        .toolbar-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-button:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .toolbar-button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .toolbar-button.primary:hover {
            background: #2563eb;
        }

        .toolbar-button.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .toolbar-button svg {
            width: 16px;
            height: 16px;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .drawing-tools-extended {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .drawing-tools-extended.active {
            display: flex;
        }

        .color-button {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.15s;
        }

        .color-button:hover {
            transform: scale(1.1);
        }

        .color-button.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #eff6ff;
        }

        .line-width-button {
            width: 28px;
            height: 28px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .line-width-button:hover {
            background: #f1f5f9;
        }

        .line-width-button.active {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .line-width-indicator {
            background: #475569;
            border-radius: 50%;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        /* å·¦ä¾§ Outline */
        .outline-panel {
            width: 260px;
            background: white;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            transition: margin-left 0.3s;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .outline-panel.collapsed {
            margin-left: -260px;
        }

        .outline-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .outline-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
        }

        .outline-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #64748b;
            display: flex;
            border-radius: 4px;
        }

        .outline-toggle:hover {
            background: #f8fafc;
        }

        /* Outline å±‚çº§è¿‡æ»¤ */
        .outline-filter {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .outline-filter-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            color: #64748b;
        }

        .outline-filter-btn:hover {
            background: #f8fafc;
        }

        .outline-filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .outline-list {
            padding: 8px;
            overflow-y: auto;
            flex: 1;
        }

        .outline-item {
            padding: 8px 12px;
            font-size: 13px;
            color: #475569;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 2px;
            display: block;
            text-decoration: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .outline-item:hover {
            background: #f8fafc;
            color: #1e293b;
        }

        .outline-item.level-1 {
            padding-left: 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .outline-item.level-2 {
            padding-left: 24px;
            font-weight: 500;
        }

        .outline-item.level-3 {
            padding-left: 36px;
            font-size: 12px;
        }

        .outline-item.level-4 {
            padding-left: 48px;
            font-size: 12px;
            color: #64748b;
        }

        .outline-item.level-5 {
            padding-left: 60px;
            font-size: 11px;
            color: #94a3b8;
        }

        .outline-item.hidden {
            display: none;
        }

        .outline-empty {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 13px;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .notebook-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 32px 20px;
        }

        .notebook-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .notebook-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .notebook-meta {
            font-size: 13px;
            color: #64748b;
        }

        .notebook-cell {
            margin-bottom: 20px;
        }

        .cell-markdown .markdown-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            line-height: 1.7;
        }

        .markdown-content h1 {
            font-size: 1.8em;
            margin: 0.8em 0 0.4em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.3em;
        }

        .markdown-content h2 {
            font-size: 1.4em;
            margin: 0.8em 0 0.4em;
        }

        .markdown-content h3 {
            font-size: 1.2em;
            margin: 0.8em 0 0.4em;
        }

        .markdown-content h4 {
            font-size: 1.1em;
            margin: 0.8em 0 0.4em;
            color: #475569;
        }

        .markdown-content h5 {
            font-size: 1em;
            margin: 0.8em 0 0.4em;
            color: #64748b;
        }

        .markdown-content p {
            margin: 0.6em 0;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 0.6em 0;
            padding-left: 1.8em;
        }

        .markdown-content code {
            background: #f1f5f9;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: #f1f5f9;
            padding: 14px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .markdown-content img {
            max-width: 100%;
            border-radius: 8px;
        }

        .cell-code {
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .code-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-code-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .toggle-code-btn:hover {
            background: #e2e8f0;
        }

        .code-label {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 600;
        }

        .run-code-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .run-code-btn:hover {
            background: #059669;
        }

        .run-code-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .code-block {
            padding: 14px;
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .code-wrapper.collapsed .code-block {
            display: none;
        }

        .code-output {
            padding: 14px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .output-text pre {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 12px;
            overflow-x: auto;
        }

        .output-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 10px;
            color: #dc2626;
        }

        .output-error .error-title {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .output-html {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-top: 8px;
        }

        .output-html table {
            border-collapse: collapse;
            width: 100%;
        }

        .output-html th,
        .output-html td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }

        .output-html th {
            background: #f8fafc;
            font-weight: 600;
        }

        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 999;
            background: transparent;
        }

        .drawing-canvas.active {
            pointer-events: auto;
            cursor: crosshair;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-state-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 15px;
            color: #64748b;
            max-width: 360px;
            margin: 0 auto;
        }

        .loading-overlay {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 250, 252, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            top: 72px;
            right: 16px;
            padding: 10px 18px;
            background: #1e293b;
            color: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            z-index: 3000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <div class="toolbar-section">
            <div class="file-input-wrapper">
                <label for="file-input" class="toolbar-button primary">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    é€‰æ‹© Notebook
                </label>
                <input type="file" id="file-input" accept=".ipynb" onchange="handleFileSelect(event)">
            </div>
            <span id="file-name" style="font-size: 13px; color: #64748b;"></span>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-section">
            <button class="toolbar-button" id="outline-toggle-btn" onclick="toggleOutline()">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                ç›®å½•
            </button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-section">
            <button class="toolbar-button" id="drawing-toggle" onclick="toggleDrawing()">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                ç”»ç¬”
            </button>
            <div class="drawing-tools-extended" id="drawing-tools">
                <button class="toolbar-button active" id="pen-tool" onclick="setTool('pen')" title="ç”»ç¬”"><svg fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg></button>
                <button class="toolbar-button" id="eraser-tool" onclick="setTool('eraser')" title="æ©¡çš®æ“¦"><svg fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M20 20H7L3 16c-1-1-1-2.5 0-3.5l9.5-9.5c1-1 2.5-1 3.5 0l4 4c1 1 1 2.5 0 3.5L11.5 19M18 13l-6 6" />
                    </svg></button>
                <div class="toolbar-divider" style="height: 18px;"></div>
                <!-- é¢œè‰²ï¼š8ä¸ªé¢„è®¾é¢œè‰² -->
                <div class="color-button active" style="background: #ef4444;" onclick="setColor('#ef4444')" title="çº¢è‰²">
                </div>
                <div class="color-button" style="background: #3b82f6;" onclick="setColor('#3b82f6')" title="è“è‰²"></div>
                <div class="color-button" style="background: #22c55e;" onclick="setColor('#22c55e')" title="ç»¿è‰²"></div>
                <div class="color-button" style="background: #eab308;" onclick="setColor('#eab308')" title="é»„è‰²"></div>
                <div class="color-button" style="background: #a855f7;" onclick="setColor('#a855f7')" title="ç´«è‰²"></div>
                <div class="color-button" style="background: #f97316;" onclick="setColor('#f97316')" title="æ©™è‰²"></div>
                <div class="color-button" style="background: #1f2937;" onclick="setColor('#1f2937')" title="é»‘è‰²"></div>
                <div class="color-button" style="background: #fff; border-color: #cbd5e1;" onclick="setColor('#ffffff')"
                    title="ç™½è‰²"></div>
                <div class="toolbar-divider" style="height: 18px;"></div>
                <!-- çº¿å®½ï¼š5ä¸ªé€‰é¡¹ -->
                <button class="line-width-button" onclick="setLineWidth(2)" id="width-2" title="æç»†"><span
                        class="line-width-indicator" style="width:3px;height:3px;"></span></button>
                <button class="line-width-button active" onclick="setLineWidth(4)" id="width-4" title="ç»†"><span
                        class="line-width-indicator" style="width:6px;height:6px;"></span></button>
                <button class="line-width-button" onclick="setLineWidth(6)" id="width-6" title="ä¸­"><span
                        class="line-width-indicator" style="width:9px;height:9px;"></span></button>
                <button class="line-width-button" onclick="setLineWidth(8)" id="width-8" title="ç²—"><span
                        class="line-width-indicator" style="width:12px;height:12px;"></span></button>
                <button class="line-width-button" onclick="setLineWidth(12)" id="width-12" title="æç²—"><span
                        class="line-width-indicator" style="width:16px;height:16px;"></span></button>
                <div class="toolbar-divider" style="height: 18px;"></div>
                <button class="toolbar-button" onclick="clearDrawing()" title="æ¸…é™¤"><svg fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg></button>
                <button class="toolbar-button" onclick="saveDrawing()" title="ä¿å­˜"><svg fill="none" stroke="currentColor"
                        stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg></button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="outline-panel" id="outline-panel">
            <div class="outline-header">
                <span class="outline-title">ğŸ“‘ ç›®å½•å¤§çº²</span>
                <button class="outline-toggle" onclick="toggleOutline()" title="æ”¶èµ·ç›®å½•">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </button>
            </div>
            <div class="outline-filter" id="outline-filter">
                <button class="outline-filter-btn active" onclick="setOutlineLevel(5)" title="æ˜¾ç¤ºæ‰€æœ‰çº§åˆ«">å…¨éƒ¨</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(1)" title="åªæ˜¾ç¤º H1">H1</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(2)" title="æ˜¾ç¤ºåˆ° H2">H2</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(3)" title="æ˜¾ç¤ºåˆ° H3">H3</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(4)" title="æ˜¾ç¤ºåˆ° H4">H4</button>
            </div>
            <div class="outline-list" id="outline-list">
                <div class="outline-empty">åŠ è½½ Notebook åæ˜¾ç¤ºç›®å½•</div>
            </div>
        </div>
        <div class="content-wrapper" id="content-wrapper">
            <canvas id="drawing-canvas" class="drawing-canvas"></canvas>
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ““</div>
                <h2 class="empty-state-title">Notebook æŸ¥çœ‹å™¨</h2>
                <p class="empty-state-text">ç‚¹å‡»ä¸Šæ–¹"é€‰æ‹© Notebook"æŒ‰é’®ï¼ŒåŠ è½½ .ipynb æ–‡ä»¶å¼€å§‹ä½¿ç”¨</p>
            </div>
        </div>
    </div>

    <!-- iPad è°ƒè¯•é¢æ¿ -->
    <div id="ipad-debug-panel" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.85);
        color: #0f0;
        font-family: monospace;
        font-size: 12px;
        padding: 12px 16px;
        border-radius: 8px;
        z-index: 99999;
        max-width: 280px;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    ">
        <div style="font-weight: bold; margin-bottom: 8px; color: #fff;">ğŸ”§ iPad è°ƒè¯•é¢æ¿</div>
        <div id="debug-touch-type">touchType: -</div>
        <div id="debug-radius">radius: -</div>
        <div id="debug-force">force: -</div>
        <div id="debug-is-stylus" style="font-weight: bold; margin-top: 4px;">isStylus: -</div>
        <div id="debug-drawing-active" style="color: #ff0;">drawingActive: -</div>
        <div id="debug-log" style="margin-top: 8px; max-height: 60px; overflow-y: auto; font-size: 10px; color: #aaa;">
        </div>
        <button onclick="document.getElementById('ipad-debug-panel').style.display='none'"
            style="margin-top: 8px; font-size: 10px; padding: 4px 8px; cursor: pointer;">å…³é—­é¢æ¿</button>
    </div>

    <script type="module">
        let currentNotebook = null;
        let currentFileName = '';
        let drawingActive = false;
        let currentTool = 'pen';
        let currentColor = '#ef4444';
        let currentLineWidth = 4;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let drawingData = [];
        let pyodideInstance = null;
        let currentOutlineLevel = 5;

        let canvas = document.getElementById('drawing-canvas');
        let ctx = canvas.getContext('2d');

        // âœ¨ Hover æ£€æµ‹çŠ¶æ€ï¼ˆApple Pencil æ‚¬åœè‡ªåŠ¨æ¿€æ´»æ¶‚é¸¦ï¼‰
        const hoverState = {
            isHovering: false,           // å½“å‰æ˜¯å¦æ‚¬åœ
            activationTimer: null,       // 300ms æ¿€æ´»å®šæ—¶å™¨
            deactivationTimer: null,     // 3000ms å…³é—­å®šæ—¶å™¨
            autoActivated: false         // æ˜¯å¦ç”± hover è‡ªåŠ¨æ¿€æ´»
        };

        // âœ¨ é•¿æŒ‰åˆ‡æ¢å·¥å…·çŠ¶æ€ï¼ˆä¸åŸç‰ˆ GlobalDrawingCanvas.js å®Œå…¨ä¸€è‡´ï¼‰
        const longPressState = {
            timer: null,                 // é•¿æŒ‰å®šæ—¶å™¨
            startX: 0,                   // èµ·å§‹ X åæ ‡
            startY: 0,                   // èµ·å§‹ Y åæ ‡
            isActive: false,             // æ˜¯å¦æ­£åœ¨é•¿æŒ‰ä¸­
            hasMoved: false              // æ˜¯å¦å·²ç»ç§»åŠ¨ï¼ˆç§»åŠ¨åˆ™å–æ¶ˆé•¿æŒ‰ï¼‰
        };

        // âœ¨ äº‹ä»¶å¤„ç†å‡½æ•°å¼•ç”¨ï¼ˆç”¨äºæ­£ç¡®æ·»åŠ /ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼‰
        const handlers = {
            mousedown: null,
            mousemove: null,
            mouseup: null,
            touchstart: null,
            touchmove: null,
            touchend: null,
            pointerdown: null,
            pointerup: null,
            pointermove: null,
            pointerleave: null
        };

        // âœ¨ åˆ¤æ–­æ˜¯å¦ä¸º Apple Pencilï¼ˆè§¦æ§ç¬”ï¼‰- å®Œå…¨å¤åˆ¶åŸç‰ˆ GlobalDrawingCanvas.js
        function isStylus(touch) {
            // æ›´æ–°è°ƒè¯•é¢æ¿
            updateDebugPanel(touch);

            // æ ‡å‡†æ–¹å¼ï¼šæ£€æŸ¥ touchType å±æ€§
            // touchType: 'stylus' - Apple Pencil
            // touchType: 'direct' - æ‰‹æŒ‡ç›´æ¥è§¦æ‘¸
            if (touch.touchType !== undefined) {
                const result = touch.touchType === 'stylus';
                updateDebugResult(result, `touchType=${touch.touchType}`);
                return result;
            }

            // é™çº§æ–¹æ¡ˆï¼šæ£€æŸ¥è§¦æ‘¸åŠå¾„ï¼ˆradiusX/radiusYï¼‰
            // Apple Pencil çš„è§¦æ‘¸åŠå¾„é€šå¸¸å¾ˆå°ï¼ˆ<8ï¼‰
            // æ‰‹æŒ‡çš„è§¦æ‘¸åŠå¾„è¾ƒå¤§ï¼ˆ>10ï¼‰
            // æ‰‹æŒçš„è§¦æ‘¸åŠå¾„éå¸¸å¤§ï¼ˆ>20ï¼‰
            if (touch.radiusX !== undefined && touch.radiusY !== undefined) {
                const avgRadius = (touch.radiusX + touch.radiusY) / 2;
                // å¦‚æœå¹³å‡åŠå¾„å°äº8ï¼Œå¾ˆå¯èƒ½æ˜¯ Apple Pencil
                if (avgRadius < 8) {
                    updateDebugResult(true, `avgRadius=${avgRadius.toFixed(1)}<8`);
                    return true;
                }
                // å¦‚æœåŠå¾„å¾ˆå¤§ï¼ˆ>15ï¼‰ï¼Œè‚¯å®šä¸æ˜¯ Apple Pencil
                if (avgRadius > 15) {
                    updateDebugResult(false, `avgRadius=${avgRadius.toFixed(1)}>15`);
                    return false;
                }
            }

            // æ— æ³•ç¡®å®šï¼šé»˜è®¤ä¿å®ˆå¤„ç†
            // åœ¨ç”»ç¬”æ¨¡å¼ä¸‹ï¼Œå‡è®¾æ˜¯ Apple Pencilï¼ˆå…è®¸ç»˜åˆ¶ï¼‰
            updateDebugResult(true, 'fallback=true');
            return true;
        }

        // âœ¨ iPad è°ƒè¯•é¢æ¿åŠŸèƒ½
        function updateDebugPanel(touch) {
            const panel = document.getElementById('ipad-debug-panel');
            if (!panel) return;

            document.getElementById('debug-touch-type').textContent =
                `touchType: ${touch.touchType !== undefined ? touch.touchType : 'undefined'}`;
            document.getElementById('debug-radius').textContent =
                `radius: X=${touch.radiusX?.toFixed(1) || '-'} Y=${touch.radiusY?.toFixed(1) || '-'} avg=${((touch.radiusX + touch.radiusY) / 2).toFixed(1) || '-'}`;
            document.getElementById('debug-force').textContent =
                `force: ${touch.force !== undefined ? touch.force.toFixed(2) : 'undefined'}`;
            document.getElementById('debug-drawing-active').textContent =
                `drawingActive: ${drawingActive}`;
        }

        function updateDebugResult(result, reason) {
            const el = document.getElementById('debug-is-stylus');
            if (el) {
                el.textContent = `isStylus: ${result} (${reason})`;
                el.style.color = result ? '#0f0' : '#f00';
            }
            addDebugLog(`isStylus=${result}: ${reason}`);
        }

        function addDebugLog(msg) {
            const log = document.getElementById('debug-log');
            if (log) {
                const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                log.innerHTML = `<div>${time} ${msg}</div>` + log.innerHTML;
                // åªä¿ç•™æœ€è¿‘ 10 æ¡
                while (log.children.length > 10) {
                    log.removeChild(log.lastChild);
                }
            }
        }

        // âœ¨ ä¸‰å‡»æ˜¾ç¤ºè°ƒè¯•é¢æ¿
        let tapCount = 0;
        let tapTimer = null;
        document.addEventListener('touchend', e => {
            if (e.touches.length === 0 && e.changedTouches.length === 1) {
                tapCount++;
                clearTimeout(tapTimer);
                tapTimer = setTimeout(() => {
                    if (tapCount >= 3) {
                        const panel = document.getElementById('ipad-debug-panel');
                        if (panel) {
                            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                            showToast('ğŸ”§ è°ƒè¯•é¢æ¿å·²' + (panel.style.display === 'none' ? 'å…³é—­' : 'æ‰“å¼€'), 'info');
                        }
                    }
                    tapCount = 0;
                }, 400);
            }
        }, { passive: true });

        // ==================== æ–‡ä»¶å¤„ç† ====================
        window.handleFileSelect = async function (event) {
            const file = event.target.files[0];
            if (!file) return;
            currentFileName = file.name;
            document.getElementById('file-name').textContent = file.name;
            showLoading();
            try {
                const text = await file.text();
                const notebook = JSON.parse(text);
                currentNotebook = notebook;
                await renderNotebook(notebook);
                loadDrawingData();
                showToast('Notebook åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showToast('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        };

        async function renderNotebook(notebook) {
            const cells = notebook.cells || [];
            const contentWrapper = document.getElementById('content-wrapper');

            // é‡æ–°è®¾ç½®å†…å®¹ï¼ŒåŒæ—¶æ·»åŠ  canvas
            contentWrapper.innerHTML = `
                <canvas id="drawing-canvas" class="drawing-canvas"></canvas>
                <div class="notebook-container">
                    <div class="notebook-header">
                        <div class="notebook-title">${escapeHtml(currentFileName)}</div>
                        <div class="notebook-meta">å…± ${cells.length} ä¸ªå•å…ƒæ ¼</div>
                    </div>
                    <div class="notebook-content" id="notebook-content"></div>
                </div>`;

            // é‡æ–°è·å– canvas å¼•ç”¨
            const newCanvas = document.getElementById('drawing-canvas');
            if (newCanvas && newCanvas !== canvas) {
                // æ›´æ–°å…¨å±€ canvas å’Œ ctx å¼•ç”¨
                Object.assign(canvas, newCanvas);
                canvas = newCanvas;
                ctx = canvas.getContext('2d');
                // é‡æ–°ç»‘å®šäº‹ä»¶
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                canvas.addEventListener('touchstart', e => { e.preventDefault(); const t = e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousedown', { clientX: t.clientX, clientY: t.clientY })); }, { passive: false });
                canvas.addEventListener('touchmove', e => { e.preventDefault(); const t = e.touches[0]; canvas.dispatchEvent(new MouseEvent('mousemove', { clientX: t.clientX, clientY: t.clientY })); }, { passive: false });
                canvas.addEventListener('touchend', e => { e.preventDefault(); canvas.dispatchEvent(new MouseEvent('mouseup', {})); });
            }

            const contentEl = document.getElementById('notebook-content');
            cells.forEach((cell, index) => {
                const cellEl = document.createElement('div');
                cellEl.className = `notebook-cell cell-${cell.cell_type}`;
                cellEl.innerHTML = renderCell(cell, index);
                contentEl.appendChild(cellEl);
            });

            // æ¸²æŸ“æ•°å­¦å…¬å¼
            if (typeof renderMathInElement !== 'undefined') {
                setTimeout(() => {
                    renderMathInElement(contentEl, {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '$', right: '$', display: false },
                            { left: '\\[', right: '\\]', display: true },
                            { left: '\\(', right: '\\)', display: false }
                        ],
                        throwOnError: false
                    });
                }, 100);
            }

            // æ¸²æŸ“ Mermaid
            const mermaidDiagrams = contentEl.querySelectorAll('.mermaid-diagram');
            if (mermaidDiagrams.length > 0 && window.mermaid) {
                setTimeout(async () => {
                    try { await window.mermaid.run({ nodes: mermaidDiagrams }); } catch (e) { console.error('Mermaid error:', e); }
                }, 300);
            }

            buildOutline(contentEl);
            resizeCanvas();

            // æ‰§è¡Œ HTML è¾“å‡ºä¸­çš„è„šæœ¬
            setTimeout(() => {
                executeHtmlScripts(contentEl);
            }, 500);
        }

        // æ‰§è¡Œ HTML è¾“å‡ºä¸­åµŒå…¥çš„è„šæœ¬
        function executeHtmlScripts(container) {
            const scriptContainers = container.querySelectorAll('.output-html-with-script[data-script-pending="true"]');
            scriptContainers.forEach(div => {
                div.removeAttribute('data-script-pending');
                const scripts = div.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    // å¤åˆ¶æ‰€æœ‰å±æ€§
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    // å¤åˆ¶è„šæœ¬å†…å®¹
                    newScript.textContent = oldScript.textContent;
                    // æ›¿æ¢æ—§è„šæœ¬
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            });
            console.log(`[Notebook] æ‰§è¡Œäº† ${scriptContainers.length} ä¸ª HTML è¾“å‡ºä¸­çš„è„šæœ¬`);
        }

        function renderCell(cell, index) {
            if (!cell || !cell.source) return '<div class="empty-cell">ç©ºå•å…ƒæ ¼</div>';
            const content = Array.isArray(cell.source) ? cell.source.join('') : cell.source;
            if (cell.cell_type === 'markdown') return renderMarkdownCell(content);
            if (cell.cell_type === 'code') return renderCodeCell(content, index, cell.outputs);
            return `<div class="raw-cell"><pre>${escapeHtml(content)}</pre></div>`;
        }

        function renderMarkdownCell(content) {
            if (typeof marked === 'undefined') return `<div class="markdown-content"><pre>${escapeHtml(content)}</pre></div>`;
            try {
                const mathMap = new Map(), mermaidMap = new Map();
                let counter = 0, protectedContent = content;
                protectedContent = protectedContent.replace(/```mermaid\n([\s\S]+?)```/g, (m, code) => { const p = `MERMAID${counter++}END`; mermaidMap.set(p, code.trim()); return p; });
                protectedContent = protectedContent.replace(/\$\$([\s\S]+?)\$\$/g, m => { const p = `MATH${counter++}END`; mathMap.set(p, m); return p; });
                protectedContent = protectedContent.replace(/\$([^\$\n]+?)\$/g, m => { const p = `MATH${counter++}END`; mathMap.set(p, m); return p; });
                marked.setOptions({ gfm: true, breaks: false, tables: true });
                let html = marked.parse(protectedContent);
                mathMap.forEach((v, k) => { html = html.replace(new RegExp(k, 'g'), v); });
                mermaidMap.forEach((v, k) => { html = html.replace(new RegExp(k, 'g'), `<div class="mermaid-diagram">${escapeHtml(v)}</div>`); });
                return `<div class="markdown-content">${html}</div>`;
            } catch (e) { return `<div class="markdown-content"><pre>${escapeHtml(content)}</pre></div>`; }
        }

        function renderCodeCell(content, index, outputs) {
            const codeId = `code-${index}`;
            let outputsHtml = '';
            if (outputs && outputs.length > 0) {
                outputsHtml = '<div class="code-output">';
                outputs.forEach(o => {
                    if (o.output_type === 'stream') { const t = Array.isArray(o.text) ? o.text.join('') : o.text; outputsHtml += `<div class="output-text"><pre>${escapeHtml(t)}</pre></div>`; }
                    else if ((o.output_type === 'execute_result' || o.output_type === 'display_data') && o.data) {
                        if (o.data['text/html']) {
                            const h = Array.isArray(o.data['text/html']) ? o.data['text/html'].join('') : o.data['text/html'];
                            // ä½¿ç”¨ç‰¹æ®Šå®¹å™¨æ¥æ ‡è®°éœ€è¦æ‰§è¡Œè„šæœ¬çš„ HTML
                            outputsHtml += `<div class="output-html output-html-with-script" data-script-pending="true">${h}</div>`;
                        }
                        else if (o.data['text/plain']) { const t = Array.isArray(o.data['text/plain']) ? o.data['text/plain'].join('') : o.data['text/plain']; outputsHtml += `<div class="output-text"><pre>${escapeHtml(t)}</pre></div>`; }
                        if (o.data['image/png']) outputsHtml += `<div class="output-plot"><img src="data:image/png;base64,${o.data['image/png']}" style="max-width:100%;"></div>`;
                    }
                    else if (o.output_type === 'error') { const t = o.traceback ? o.traceback.join('\n') : o.evalue || 'Error'; outputsHtml += `<div class="output-error"><div class="error-title">é”™è¯¯:</div><pre>${escapeHtml(t)}</pre></div>`; }
                });
                outputsHtml += '</div>';
            }
            return `<div class="code-wrapper collapsed" data-code-id="${codeId}">
                <div class="code-header">
                    <div class="code-header-left">
                        <button class="toggle-code-btn" onclick="toggleCode('${codeId}')"><svg class="icon-collapsed" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 5l7 7-7 7"/></svg><svg class="icon-expanded" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path d="M5 9l7 7 7-7"/></svg><span class="toggle-text">æ˜¾ç¤ºä»£ç </span></button>
                        <span class="code-label">Python</span>
                    </div>
                    <button class="run-code-btn" onclick="runCode('${codeId}')"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>è¿è¡Œ</button>
                </div>
                <pre class="code-block" style="display:none;"><code data-code="${codeId}">${escapeHtml(content)}</code></pre>
                ${outputsHtml}
                <div class="code-output-dynamic" id="output-${codeId}" style="display:none;"></div>
            </div>`;
        }

        function escapeHtml(text) { const m = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return String(text).replace(/[&<>"']/g, c => m[c]); }

        // ==================== ä»£ç æ‰§è¡Œ ====================
        window.toggleCode = function (codeId) {
            const w = document.querySelector(`[data-code-id="${codeId}"]`);
            const cb = w.querySelector('.code-block'), tb = w.querySelector('.toggle-code-btn'), ic = tb.querySelector('.icon-collapsed'), ie = tb.querySelector('.icon-expanded'), tt = tb.querySelector('.toggle-text');
            if (w.classList.contains('collapsed')) { w.classList.remove('collapsed'); cb.style.display = 'block'; ic.style.display = 'none'; ie.style.display = 'inline'; tt.textContent = 'éšè—ä»£ç '; }
            else { w.classList.add('collapsed'); cb.style.display = 'none'; ic.style.display = 'inline'; ie.style.display = 'none'; tt.textContent = 'æ˜¾ç¤ºä»£ç '; }
        };

        window.runCode = async function (codeId) {
            const codeEl = document.querySelector(`code[data-code="${codeId}"]`);
            const outputEl = document.getElementById(`output-${codeId}`);
            const btn = document.querySelector(`[data-code-id="${codeId}"] .run-code-btn`);
            if (!codeEl || !outputEl) return;
            const code = codeEl.textContent;
            btn.disabled = true; btn.textContent = 'æ‰§è¡Œä¸­...';
            outputEl.style.display = 'block';
            outputEl.innerHTML = '<div class="output-text"><pre>æ­£åœ¨åˆå§‹åŒ– Python ç¯å¢ƒï¼ˆé¦–æ¬¡è¿è¡Œéœ€ä¸‹è½½ IPythonï¼Œçº¦ 10-20 ç§’ï¼‰...</pre></div>';

            try {
                if (!pyodideInstance) {
                    pyodideInstance = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/' });
                    await pyodideInstance.loadPackage(['micropip', 'numpy', 'matplotlib']);
                    await pyodideInstance.runPythonAsync(`
import micropip
await micropip.install('ipython')
                    `);
                    pyodideInstance.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
_display_outputs = []

def _capture_display(*args, **kwargs):
    for arg in args:
        if hasattr(arg, '_repr_html_'):
            _display_outputs.append(('html', arg._repr_html_()))
        elif hasattr(arg, 'data'):
            _display_outputs.append(('html', str(arg.data)))
        else:
            _display_outputs.append(('text', str(arg)))

from IPython import display as ipython_display
ipython_display.display = _capture_display

def get_display_outputs():
    global _display_outputs
    outputs = _display_outputs.copy()
    _display_outputs = []
    return outputs
                    `);
                }

                pyodideInstance.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
_display_outputs = []
                `);

                let result;
                try { result = await pyodideInstance.runPythonAsync(code); } catch (e) { throw e; }

                const output = pyodideInstance.runPython(`sys.stdout.getvalue()`);
                const displayOutputs = pyodideInstance.runPython(`get_display_outputs()`);

                let html = '';
                if (output && output.trim()) html += `<div class="output-text"><pre>${escapeHtml(output)}</pre></div>`;

                if (displayOutputs && displayOutputs.length > 0) {
                    for (let i = 0; i < displayOutputs.length; i++) {
                        const item = displayOutputs.get(i);
                        const type = item.get(0);
                        const content = item.get(1);
                        if (type === 'html') html += `<div class="output-html">${content}</div>`;
                        else html += `<div class="output-text"><pre>${escapeHtml(content)}</pre></div>`;
                    }
                }

                if (result !== undefined && result !== null) {
                    const rs = String(result);
                    if (rs.includes('__HTML_CONTENT__:')) {
                        const htmlContent = rs.replace('__HTML_CONTENT__:', '').replace(':__HTML_END__', '');
                        html += `<div class="output-html">${htmlContent}</div>`;
                    } else if (!rs.includes('IPython') && !rs.includes('MockIPython') && !rs.includes('_HTML') && !rs.includes('[object') && rs !== 'undefined' && rs !== 'None') {
                        html += `<div class="output-text"><pre>${escapeHtml(rs)}</pre></div>`;
                    }
                }

                outputEl.innerHTML = html || '<div class="output-text"><pre>(æ‰§è¡ŒæˆåŠŸï¼Œæ— è¾“å‡º)</pre></div>';
                outputEl.className = 'code-output-dynamic';
            } catch (error) {
                outputEl.innerHTML = `<div class="output-error"><div class="error-title">æ‰§è¡Œé”™è¯¯:</div><pre>${escapeHtml(error.message)}</pre></div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>è¿è¡Œ';
            }
        };

        // ==================== Outline ====================
        window.toggleOutline = function () {
            document.getElementById('outline-panel').classList.toggle('collapsed');
            resizeCanvas();
        };

        window.setOutlineLevel = function (level) {
            currentOutlineLevel = level;
            document.querySelectorAll('.outline-filter-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && level === 5) || (i === level));
            });
            filterOutlineByLevel(level);
        };

        function filterOutlineByLevel(maxLevel) {
            document.querySelectorAll('.outline-item').forEach(item => {
                const levelMatch = item.className.match(/level-(\d)/);
                if (levelMatch) {
                    const itemLevel = parseInt(levelMatch[1]);
                    item.classList.toggle('hidden', itemLevel > maxLevel);
                }
            });
        }

        function buildOutline(contentEl) {
            const list = document.getElementById('outline-list');
            const headings = contentEl.querySelectorAll('.markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5');
            if (headings.length === 0) { list.innerHTML = '<div class="outline-empty">æ­¤ Notebook æ²¡æœ‰æ ‡é¢˜</div>'; return; }
            list.innerHTML = '';
            headings.forEach((h, i) => {
                const level = parseInt(h.tagName[1]);
                const id = `heading-${i}`;
                h.id = id;
                const item = document.createElement('a');
                item.className = `outline-item level-${level}`;
                item.href = `#${id}`;
                item.textContent = h.textContent.trim();
                item.title = h.textContent.trim();
                item.onclick = e => { e.preventDefault(); h.scrollIntoView({ behavior: 'smooth', block: 'start' }); };
                list.appendChild(item);
            });
            filterOutlineByLevel(currentOutlineLevel);
        }

        // ==================== æ¶‚é¸¦ ====================
        window.toggleDrawing = function () {
            drawingActive = !drawingActive;
            document.getElementById('drawing-toggle').classList.toggle('active', drawingActive);
            document.getElementById('drawing-tools').classList.toggle('active', drawingActive);
            canvas.classList.toggle('active', drawingActive);
        };

        window.setTool = function (tool) {
            currentTool = tool;
            document.getElementById('pen-tool').classList.toggle('active', tool === 'pen');
            document.getElementById('eraser-tool').classList.toggle('active', tool === 'eraser');
        };

        window.setColor = function (color) {
            currentColor = color;
            currentTool = 'pen';
            setTool('pen');
            document.querySelectorAll('.color-button').forEach(b => {
                const btnColor = b.style.backgroundColor;
                // è½¬æ¢ hex åˆ° rgb æ¯”è¾ƒ
                b.classList.toggle('active', btnColor.includes(color.slice(1)) ||
                    (color === '#ffffff' && btnColor === 'rgb(255, 255, 255)') ||
                    (color === '#1f2937' && btnColor === 'rgb(31, 41, 55)'));
            });
            // æ›´ç®€å•çš„æ–¹æ³•ï¼šé€šè¿‡é¢œè‰²å€¼åŒ¹é…
            document.querySelectorAll('.color-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.color-button[onclick="setColor('${color}')"]`)?.classList.add('active');
        };

        window.setLineWidth = function (width) {
            currentLineWidth = width;
            document.querySelectorAll('.line-width-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`width-${width}`)?.classList.add('active');
        };

        window.clearDrawing = function () {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingData = [];
            saveDrawingToStorage();
            showToast('æ¶‚é¸¦å·²æ¸…é™¤', 'success');
        };

        window.saveDrawing = function () {
            saveDrawingToStorage();
            showToast('æ¶‚é¸¦å·²ä¿å­˜', 'success');
        };

        function saveDrawingToStorage() {
            if (!currentFileName) return;
            localStorage.setItem(`drawing_${currentFileName}`, JSON.stringify(drawingData));
        }

        function loadDrawingData() {
            if (!currentFileName) return;
            const saved = localStorage.getItem(`drawing_${currentFileName}`);
            if (saved) {
                drawingData = JSON.parse(saved);
                redrawCanvas();
            } else {
                drawingData = [];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const contentWrapper = document.getElementById('content-wrapper');
            const scrollTop = contentWrapper?.scrollTop || 0;

            drawingData.forEach(s => {
                ctx.strokeStyle = s.color;
                ctx.lineWidth = s.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalCompositeOperation = s.tool === 'eraser' ? 'destination-out' : 'source-over';
                if (s.tool === 'eraser') ctx.lineWidth = s.width * 3;
                ctx.beginPath();
                // å‡å»æ»šåŠ¨åç§»ï¼Œå°†å†…å®¹åæ ‡è½¬æ¢ä¸ºå±å¹•åæ ‡
                s.points.forEach((p, i) => {
                    const screenY = p.y - scrollTop;
                    if (i === 0) ctx.moveTo(p.x, screenY);
                    else ctx.lineTo(p.x, screenY);
                });
                ctx.stroke();
            });
            ctx.globalCompositeOperation = 'source-over';
        }

        let currentStroke = null;

        // ==================== é•¿æŒ‰åˆ‡æ¢å·¥å…·åŠŸèƒ½ï¼ˆä¸åŸç‰ˆ GlobalDrawingCanvas.js å®Œå…¨ä¸€è‡´ï¼‰====================

        // âœ¨ å¯åŠ¨é•¿æŒ‰æ£€æµ‹ï¼ˆ1ç§’åˆ‡æ¢å·¥å…·ï¼‰
        function startLongPressDetection(x, y) {
            const lp = longPressState;
            lp.startX = x;
            lp.startY = y;
            lp.isActive = true;
            lp.hasMoved = false;

            // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (lp.timer) {
                clearTimeout(lp.timer);
            }

            // å¯åŠ¨1ç§’å®šæ—¶å™¨
            lp.timer = setTimeout(() => {
                // 1ç§’åæ£€æŸ¥æ˜¯å¦ä»åœ¨é•¿æŒ‰ä¸”æ²¡æœ‰ç§»åŠ¨
                if (lp.isActive && !lp.hasMoved) {
                    // åˆ‡æ¢å·¥å…·
                    const newTool = currentTool === 'pen' ? 'eraser' : 'pen';
                    setTool(newTool);

                    // æ˜¾ç¤ºæç¤º
                    const text = newTool === 'pen' ? 'âœï¸ ç”»ç¬”' : 'ğŸ§¹ æ©¡çš®æ“¦';
                    showToast(`${text}ï¼ˆé•¿æŒ‰1ç§’åˆ‡æ¢ï¼‰`, 'success');
                    console.log(`â±ï¸ é•¿æŒ‰1ç§’åˆ‡æ¢ â†’ ${text}`);

                    // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }
            }, 1000); // 1ç§’
        }

        // âœ¨ æ£€æŸ¥é•¿æŒ‰ç§»åŠ¨è·ç¦»
        function checkLongPressMovement(x, y) {
            const lp = longPressState;
            if (lp.isActive && !lp.hasMoved) {
                const distance = Math.sqrt(
                    Math.pow(x - lp.startX, 2) +
                    Math.pow(y - lp.startY, 2)
                );

                // ç§»åŠ¨è¶…è¿‡10pxï¼Œå–æ¶ˆé•¿æŒ‰æ£€æµ‹
                if (distance > 10) {
                    lp.hasMoved = true;
                    console.log('ğŸš« é•¿æŒ‰æ£€æµ‹å–æ¶ˆï¼ˆç§»åŠ¨è·ç¦»è¿‡å¤§ï¼‰');
                }
            }
        }

        // âœ¨ å–æ¶ˆé•¿æŒ‰æ£€æµ‹
        function cancelLongPressDetection() {
            const lp = longPressState;
            lp.isActive = false;
            if (lp.timer) {
                clearTimeout(lp.timer);
                lp.timer = null;
            }
        }

        // ==================== äº‹ä»¶ç»‘å®šåˆ° documentï¼ˆå®Œå…¨å¤åˆ¶åŸç‰ˆ GlobalDrawingCanvas.jsï¼‰====================
        // é‡è¦ï¼šcanvas åœ¨éæ¿€æ´»çŠ¶æ€ä¸‹ pointer-events: noneï¼Œæ‰€ä»¥äº‹ä»¶å¿…é¡»ç»‘å®šåˆ° document

        // é¼ æ ‡æŒ‰ä¸‹
        handlers.mousedown = (e) => {
            if (!drawingActive) return;
            // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨å†…å®¹åŒºåŸŸå†…
            const contentWrapper = document.getElementById('content-wrapper');
            if (!contentWrapper.contains(e.target) && e.target !== canvas) return;
            startDrawing(e);
        };

        // é¼ æ ‡ç§»åŠ¨
        handlers.mousemove = draw;

        // é¼ æ ‡æŠ¬èµ·
        handlers.mouseup = stopDrawing;

        // âœ¨ è§¦æ‘¸äº‹ä»¶ï¼ˆæ”¯æŒ Apple Pencilï¼‰- å®Œå…¨å¤åˆ¶åŸç‰ˆ
        handlers.touchstart = (e) => {
            if (!drawingActive) return; // âœ¨ å…³é”®ï¼šåªæœ‰åœ¨æ¶‚é¸¦æ¿€æ´»æ—¶æ‰å¤„ç†

            // âš ï¸ iPadä¼˜åŒ–ï¼šåªå¤„ç†å•ç‚¹è§¦æ‘¸
            if (e.touches.length !== 1) return;

            const touch = e.touches[0];

            // âœ¨ å…³é”®ï¼šæ£€æµ‹ Apple Pencil
            const isApplePencil = isStylus(touch);

            // å¦‚æœæ˜¯ Apple Pencilï¼Œæ£€æŸ¥æ˜¯å¦åœ¨å†…å®¹åŒºåŸŸ
            if (isApplePencil) {
                // âœ¨ å¯åŠ¨é•¿æŒ‰æ£€æµ‹ï¼ˆ1ç§’åˆ‡æ¢å·¥å…·ï¼‰
                startLongPressDetection(touch.clientX, touch.clientY);

                const contentWrapper = document.getElementById('content-wrapper');
                const rect = contentWrapper.getBoundingClientRect();
                if (touch.clientX < rect.left || touch.clientX > rect.right ||
                    touch.clientY < rect.top || touch.clientY > rect.bottom) {
                    return; // è§¦æ‘¸åœ¨å†…å®¹åŒºåŸŸå¤–ï¼Œå¿½ç•¥
                }

                // âœ… Apple Pencilï¼šé˜»æ­¢æ»šåŠ¨å’Œé»˜è®¤è¡Œä¸º
                e.preventDefault();
                e.stopPropagation();

                isDrawing = true;
                const scrollTop = contentWrapper?.scrollTop || 0;
                const canvasRect = canvas.getBoundingClientRect();
                const screenX = touch.clientX - canvasRect.left;
                const screenY = touch.clientY - canvasRect.top;
                lastX = screenX;
                lastY = screenY + scrollTop;
                currentStroke = { tool: currentTool, color: currentColor, width: currentLineWidth, points: [{ x: lastX, y: lastY }] };

                // åº”ç”¨ç¬”åˆ·è®¾ç½®
                ctx.strokeStyle = currentTool === 'eraser' ? '#fff' : currentColor;
                ctx.lineWidth = currentTool === 'eraser' ? currentLineWidth * 3 : currentLineWidth;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.beginPath();
                ctx.moveTo(screenX, screenY);
            } else {
                // ğŸ–ï¸ æ‰‹æŒ‡è§¦æ‘¸ï¼šä¸å¤„ç†ç»˜åˆ¶ï¼Œå…è®¸æ»šåŠ¨
                // ä¸è°ƒç”¨ preventDefault()ï¼Œè®©ç³»ç»Ÿå¤„ç†æ»šåŠ¨
                return;
            }
        };

        handlers.touchmove = (e) => {
            if (!drawingActive || !isDrawing) return;

            // âš ï¸ æ‰‹æŒé˜²è¯¯è§¦ï¼šæ£€æŸ¥è§¦æ‘¸æ•°é‡å’Œç±»å‹
            if (e.touches.length !== 1) {
                // å¤šç‚¹è§¦æ‘¸ï¼ˆå¯èƒ½æ˜¯æ‰‹æŒï¼‰ï¼šåœæ­¢ç»˜åˆ¶
                stopDrawing();
                return;
            }

            const touch = e.touches[0];

            // âœ¨ åªå¤„ç† Apple Pencil çš„ç§»åŠ¨
            if (!isStylus(touch)) {
                // é Apple Pencilï¼ˆå¯èƒ½æ˜¯æ‰‹æŒè¯¯è§¦ï¼‰ï¼šåœæ­¢ç»˜åˆ¶
                stopDrawing();
                return;
            }

            // âœ¨ é•¿æŒ‰ç§»åŠ¨æ£€æµ‹ï¼šå¦‚æœç§»åŠ¨è¶…è¿‡10pxï¼Œå–æ¶ˆé•¿æŒ‰
            checkLongPressMovement(touch.clientX, touch.clientY);

            // âœ… Apple Pencil ç§»åŠ¨ï¼šé˜»æ­¢æ»šåŠ¨ï¼Œæ‰§è¡Œç»˜åˆ¶
            e.preventDefault();
            e.stopPropagation();

            const contentWrapper = document.getElementById('content-wrapper');
            const scrollTop = contentWrapper?.scrollTop || 0;
            const canvasRect = canvas.getBoundingClientRect();
            const screenX = touch.clientX - canvasRect.left;
            const screenY = touch.clientY - canvasRect.top;
            const contentX = screenX;
            const contentY = screenY + scrollTop;

            // ç»˜åˆ¶çº¿æ¡
            ctx.lineTo(screenX, screenY);
            ctx.stroke();

            // è®°å½•ç¬”åˆ’ç‚¹
            if (currentStroke) {
                currentStroke.points.push({ x: contentX, y: contentY });
            }

            lastX = contentX;
            lastY = contentY;
        };

        handlers.touchend = (e) => {
            if (isDrawing) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ Apple Pencil ç»“æŸ
                const touch = e.changedTouches?.[0];
                if (touch && isStylus(touch)) {
                    // Apple Pencil æŠ¬èµ·ï¼šé˜»æ­¢å¯èƒ½çš„æ»šåŠ¨æƒ¯æ€§
                    e.preventDefault();
                }

                // âœ¨ å–æ¶ˆé•¿æŒ‰æ£€æµ‹
                cancelLongPressDetection();

                stopDrawing();
            }
        };

        // âœ¨ Hover æ£€æµ‹
        handlers.pointermove = (e) => {
            // åªå¤„ç† Apple Pencil
            if (e.pointerType !== 'pen') return;

            // âœ¨ é•¿æŒ‰ç§»åŠ¨æ£€æµ‹ï¼šå¦‚æœç§»åŠ¨è¶…è¿‡10pxï¼Œå–æ¶ˆé•¿æŒ‰
            const lp = longPressState;
            if (lp.isActive && !lp.hasMoved) {
                const distance = Math.sqrt(
                    Math.pow(e.clientX - lp.startX, 2) +
                    Math.pow(e.clientY - lp.startY, 2)
                );

                // ç§»åŠ¨è¶…è¿‡10pxï¼Œå–æ¶ˆé•¿æŒ‰æ£€æµ‹
                if (distance > 10) {
                    lp.hasMoved = true;
                    console.log('ğŸš« é•¿æŒ‰æ£€æµ‹å–æ¶ˆï¼ˆç§»åŠ¨è·ç¦»è¿‡å¤§ï¼‰');
                }
            }

            // åˆ¤æ–­æ˜¯å¦æ‚¬åœï¼ˆpressure === 0 è¡¨ç¤ºç¬”æœªæ¥è§¦å±å¹•ï¼‰
            const hovering = e.pressure === 0;
            const wasHovering = hoverState.isHovering;

            if (hovering && !wasHovering) {
                // ğŸŸ¢ å¼€å§‹æ‚¬åœ
                hoverState.isHovering = true;
                cancelHoverDeactivation(); // å–æ¶ˆå…³é—­è®¡æ—¶
                startHoverActivation();     // å¼€å§‹æ¿€æ´»è®¡æ—¶ï¼ˆ300msï¼‰
                console.log('ğŸ–Šï¸ Apple Pencil å¼€å§‹æ‚¬åœ');
            } else if (!hovering && wasHovering) {
                // ğŸ”´ ç¬”æ¥è§¦å±å¹•ï¼Œåœæ­¢æ‚¬åœ
                hoverState.isHovering = false;
                cancelHoverActivation(); // å–æ¶ˆæ¿€æ´»è®¡æ—¶
                console.log('ğŸ–Šï¸ Apple Pencil æ¥è§¦å±å¹•');
            }
        };

        handlers.pointerleave = (e) => {
            // åªå¤„ç† Apple Pencil
            if (e.pointerType !== 'pen') return;

            const wasHovering = hoverState.isHovering;

            if (wasHovering) {
                // ç¬”ç¦»å¼€å±å¹•
                hoverState.isHovering = false;
                cancelHoverActivation(); // å–æ¶ˆæ¿€æ´»è®¡æ—¶

                // ä»…å½“ç”± hover è‡ªåŠ¨æ¿€æ´»æ—¶ï¼Œæ‰å¯åŠ¨å…³é—­è®¡æ—¶
                if (hoverState.autoActivated && drawingActive) {
                    startHoverDeactivation(); // 3000ms åå…³é—­
                    console.log('ğŸ–Šï¸ Apple Pencil ç¦»å¼€ï¼Œ3000ms åè‡ªåŠ¨å…³é—­');
                } else {
                    console.log('ğŸ–Šï¸ Apple Pencil ç¦»å¼€ï¼ˆæ‰‹åŠ¨æ¿€æ´»æ¨¡å¼ï¼Œä¸è‡ªåŠ¨å…³é—­ï¼‰');
                }
            }
        };

        // ==================== æ·»åŠ äº‹ä»¶ç›‘å¬ï¼ˆä¸åŸç‰ˆå®Œå…¨ä¸€è‡´ï¼‰====================
        document.addEventListener('mousedown', handlers.mousedown, true);
        document.addEventListener('mousemove', handlers.mousemove);
        document.addEventListener('mouseup', handlers.mouseup);
        document.addEventListener('touchstart', handlers.touchstart, { passive: false, capture: true });
        document.addEventListener('touchmove', handlers.touchmove, { passive: false });
        document.addEventListener('touchend', handlers.touchend);

        // âœ¨ Hover æ£€æµ‹ç›‘å¬å™¨
        document.addEventListener('pointermove', handlers.pointermove, { passive: true });
        document.addEventListener('pointerleave', handlers.pointerleave, true);

        // âœ¨ Hover æ¿€æ´»ï¼š300ms åè‡ªåŠ¨å¼€å¯æ¶‚é¸¦
        function startHoverActivation() {
            cancelHoverActivation();
            hoverState.activationTimer = setTimeout(() => {
                if (hoverState.isHovering && !drawingActive) {
                    toggleDrawing();
                    hoverState.autoActivated = true;
                    showToast('âœ¨ Hover æ¿€æ´»æ¶‚é¸¦', 'success');
                    console.log('âœ… Hover 300ms è¾¾æˆï¼Œè‡ªåŠ¨æ¿€æ´»æ¶‚é¸¦æ¨¡å¼');
                }
            }, 300);
        }

        function cancelHoverActivation() {
            if (hoverState.activationTimer) {
                clearTimeout(hoverState.activationTimer);
                hoverState.activationTimer = null;
            }
        }

        // âœ¨ Hover å…³é—­ï¼šç¬”ç¦»å¼€ 3s åè‡ªåŠ¨å…³é—­æ¶‚é¸¦
        function startHoverDeactivation() {
            cancelHoverDeactivation();
            hoverState.deactivationTimer = setTimeout(() => {
                if (hoverState.autoActivated && drawingActive) {
                    toggleDrawing();
                    hoverState.autoActivated = false;
                    showToast('ğŸ’¤ Hover å…³é—­æ¶‚é¸¦', 'info');
                    console.log('â° Hover 3s è¶…æ—¶ï¼Œè‡ªåŠ¨å…³é—­æ¶‚é¸¦æ¨¡å¼');
                }
            }, 3000);
        }

        function cancelHoverDeactivation() {
            if (hoverState.deactivationTimer) {
                clearTimeout(hoverState.deactivationTimer);
                hoverState.deactivationTimer = null;
            }
        }

        function startDrawing(e) {
            if (!drawingActive) return;
            isDrawing = true;
            const contentWrapper = document.getElementById('content-wrapper');
            const scrollTop = contentWrapper?.scrollTop || 0;
            const r = canvas.getBoundingClientRect();
            const screenX = e.clientX - r.left;
            const screenY = e.clientY - r.top;
            // å­˜å‚¨å†…å®¹åæ ‡
            lastX = screenX;
            lastY = screenY + scrollTop;
            currentStroke = { tool: currentTool, color: currentColor, width: currentLineWidth, points: [{ x: lastX, y: lastY }] };
        }

        function draw(e) {
            if (!isDrawing || !drawingActive) return;
            const contentWrapper = document.getElementById('content-wrapper');
            const scrollTop = contentWrapper?.scrollTop || 0;
            const r = canvas.getBoundingClientRect();
            const screenX = e.clientX - r.left;
            const screenY = e.clientY - r.top;
            // å†…å®¹åæ ‡ = å±å¹•åæ ‡ + æ»šåŠ¨åç§»
            const contentX = screenX;
            const contentY = screenY + scrollTop;
            currentStroke.points.push({ x: contentX, y: contentY });

            ctx.strokeStyle = currentTool === 'eraser' ? '#fff' : currentColor;
            ctx.lineWidth = currentTool === 'eraser' ? currentLineWidth * 3 : currentLineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
            ctx.beginPath();
            // ç»˜åˆ¶ä½¿ç”¨å±å¹•åæ ‡
            const lastScreenY = lastY - scrollTop;
            ctx.moveTo(lastX, lastScreenY);
            ctx.lineTo(screenX, screenY);
            ctx.stroke();
            lastX = contentX;
            lastY = contentY;
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            if (currentStroke && currentStroke.points.length > 1) {
                drawingData.push(currentStroke);
                saveDrawingToStorage();
            }
            currentStroke = null;
            ctx.globalCompositeOperation = 'source-over';
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function resizeCanvas() {
            // Canvas ä½¿ç”¨è§†å£å¤§å°ï¼ˆè€Œä¸æ˜¯å®Œæ•´æ»šåŠ¨é«˜åº¦ï¼‰ï¼Œé¿å…æ€§èƒ½é—®é¢˜
            const contentWrapper = document.getElementById('content-wrapper');
            if (!contentWrapper) return;

            // è®¡ç®— outline é¢æ¿å®½åº¦
            const outlinePanel = document.getElementById('outline-panel');
            const isOutlineCollapsed = outlinePanel?.classList.contains('collapsed');
            const outlineWidth = isOutlineCollapsed ? 0 : (outlinePanel?.offsetWidth || 0);

            const width = contentWrapper.clientWidth;
            const height = contentWrapper.clientHeight; // åªä½¿ç”¨å¯è§åŒºåŸŸé«˜åº¦

            // è®¾ç½® canvas çš„å®é™…åƒç´ å°ºå¯¸
            canvas.width = width;
            canvas.height = height;

            // Canvas å®½é«˜ä¹Ÿéœ€è¦è®¾ç½® CSS å°ºå¯¸
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            // Canvas ä½¿ç”¨ fixed å®šä½åœ¨è§†å£å†…
            canvas.style.position = 'fixed';
            canvas.style.top = '56px'; // toolbar é«˜åº¦
            canvas.style.left = outlineWidth + 'px';

            console.log(`[Canvas] å°ºå¯¸å·²è°ƒæ•´: ${width}x${height}, left=${outlineWidth}px`);
            redrawCanvas();
        }

        // æ»šåŠ¨æ—¶é‡ç»˜ canvasï¼ˆæ¶‚é¸¦åæ ‡æ˜¯ç›¸å¯¹äºå†…å®¹çš„ï¼Œéœ€è¦æ ¹æ®æ»šåŠ¨åç§»é‡æ–°è®¡ç®—æ˜¾ç¤ºä½ç½®ï¼‰
        function onContentScroll() {
            redrawCanvas();
        }

        window.addEventListener('resize', resizeCanvas);
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
        setTimeout(() => {
            resizeCanvas();
            const contentWrapper = document.getElementById('content-wrapper');
            if (contentWrapper) {
                contentWrapper.addEventListener('scroll', onContentScroll);
            }
        }, 100);

        function showLoading() {
            const o = document.createElement('div');
            o.className = 'loading-overlay';
            o.id = 'loading-overlay';
            o.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(o);
        }

        function hideLoading() {
            const o = document.getElementById('loading-overlay');
            if (o) o.remove();
        }

        function showToast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 2000);
        }
    </script>
</body>

</html>