<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Notebook Viewer (Modular)</title>

    <!-- 外部依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <!-- 模块化样式 -->
    <link rel="stylesheet" href="css/notebook-viewer.css">
</head>

<body>
    <div class="toolbar">
        <div class="toolbar-section">
            <div class="file-input-wrapper">
                <label for="file-input" class="toolbar-button primary">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    选择 Notebook
                </label>
                <input type="file" id="file-input" accept=".ipynb" onchange="handleFileSelect(event)">
            </div>
            <span id="file-name" style="font-size: 13px; color: #64748b;"></span>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-section">
            <button class="toolbar-button" id="outline-toggle-btn" onclick="toggleOutline()">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                目录
            </button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-section">
            <button class="toolbar-button" id="drawing-toggle" onclick="toggleDrawing()">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                画笔
            </button>
            <div class="drawing-tools-extended" id="drawing-tools">
                <button class="toolbar-button active" id="pen-tool" onclick="setTool('pen')" title="画笔"><svg fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg></button>
                <button class="toolbar-button" id="eraser-tool" onclick="setTool('eraser')" title="橡皮擦"><svg fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M20 20H7L3 16c-1-1-1-2.5 0-3.5l9.5-9.5c1-1 2.5-1 3.5 0l4 4c1 1 1 2.5 0 3.5L11.5 19M18 13l-6 6" />
                    </svg></button>
                <div class="toolbar-divider" style="height: 18px;"></div>
                <!-- 颜色：8个预设颜色 -->
                <div class="color-button active" style="background: #ef4444;" onclick="setColor('#ef4444')" title="红色">
                </div>
                <div class="color-button" style="background: #3b82f6;" onclick="setColor('#3b82f6')" title="蓝色"></div>
                <div class="color-button" style="background: #22c55e;" onclick="setColor('#22c55e')" title="绿色"></div>
                <div class="color-button" style="background: #eab308;" onclick="setColor('#eab308')" title="黄色"></div>
                <div class="color-button" style="background: #a855f7;" onclick="setColor('#a855f7')" title="紫色"></div>
                <div class="color-button" style="background: #f97316;" onclick="setColor('#f97316')" title="橙色"></div>
                <div class="color-button" style="background: #1f2937;" onclick="setColor('#1f2937')" title="黑色"></div>
                <div class="color-button" style="background: #fff; border-color: #cbd5e1;" onclick="setColor('#ffffff')"
                    title="白色"></div>
                <div class="toolbar-divider" style="height: 18px;"></div>
                <!-- 线宽：5个选项 -->
                <button class="line-width-button" onclick="setLineWidth(2)" id="width-2" title="极细"><span
                        class="line-width-indicator" style="width:3px;height:3px;"></span></button>
                <button class="line-width-button active" onclick="setLineWidth(4)" id="width-4" title="细"><span
                        class="line-width-indicator" style="width:6px;height:6px;"></span></button>
                <button class="line-width-button" onclick="setLineWidth(6)" id="width-6" title="中"><span
                        class="line-width-indicator" style="width:9px;height:9px;"></span></button>
                <button class="line-width-button" onclick="setLineWidth(8)" id="width-8" title="粗"><span
                        class="line-width-indicator" style="width:12px;height:12px;"></span></button>
                <button class="line-width-button" onclick="setLineWidth(12)" id="width-12" title="极粗"><span
                        class="line-width-indicator" style="width:16px;height:16px;"></span></button>
                <div class="toolbar-divider" style="height: 18px;"></div>
                <button class="toolbar-button" onclick="clearDrawing()" title="清除"><svg fill="none"
                        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg></button>
                <button class="toolbar-button" onclick="saveDrawing()" title="保存"><svg fill="none" stroke="currentColor"
                        stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg></button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="outline-panel" id="outline-panel">
            <div class="outline-header">
                <span class="outline-title">📑 目录大纲</span>
                <button class="outline-toggle" onclick="toggleOutline()" title="收起目录">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </button>
            </div>
            <div class="outline-filter" id="outline-filter">
                <button class="outline-filter-btn active" onclick="setOutlineLevel(5)" title="显示所有级别">全部</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(1)" title="只显示 H1">H1</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(2)" title="显示到 H2">H2</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(3)" title="显示到 H3">H3</button>
                <button class="outline-filter-btn" onclick="setOutlineLevel(4)" title="显示到 H4">H4</button>
            </div>
            <div class="outline-list" id="outline-list">
                <div class="outline-empty">加载 Notebook 后显示目录</div>
            </div>
        </div>
        <div class="content-wrapper" id="content-wrapper">
            <canvas id="drawing-canvas" class="drawing-canvas"></canvas>
            <div class="empty-state">
                <div class="empty-state-icon">📓</div>
                <h2 class="empty-state-title">Notebook 查看器</h2>
                <p class="empty-state-text">点击上方"选择 Notebook"按钮，加载 .ipynb 文件开始使用</p>
            </div>
        </div>
    </div>

    <!-- iPad 调试面板 -->
    <div id="ipad-debug-panel" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.85);
        color: #0f0;
        font-family: monospace;
        font-size: 12px;
        padding: 12px 16px;
        border-radius: 8px;
        z-index: 99999;
        max-width: 320px;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    ">
        <div style="font-weight: bold; margin-bottom: 8px; color: #fff;">🔧 iPad 调试面板</div>
        <div id="debug-touch-type">touchType: -</div>
        <div id="debug-radius">radius: -</div>
        <div id="debug-force">force: -</div>
        <div id="debug-is-stylus" style="font-weight: bold; margin-top: 4px;">isStylus: -</div>
        <div id="debug-drawing-active" style="color: #ff0;">drawingActive: -</div>
        <div id="debug-pending" style="color: #0ff;">pending: -</div>
        <div id="debug-log" style="margin-top: 8px; max-height: 100px; overflow-y: auto; font-size: 10px; color: #aaa;">
        </div>
        <div style="margin-top: 8px; display: flex; gap: 6px;">
            <button id="debug-copy-btn"
                style="font-size: 10px; padding: 4px 8px; cursor: pointer; background: #22c55e; color: white; border: none; border-radius: 4px;">📋
                复制日志</button>
            <button onclick="document.getElementById('ipad-debug-panel').style.display='none'"
                style="font-size: 10px; padding: 4px 8px; cursor: pointer; border-radius: 4px;">关闭面板</button>
        </div>
    </div>

    <!-- 模块化 JavaScript -->
    <script type="module" src="js/main.js"></script>
</body>

</html>